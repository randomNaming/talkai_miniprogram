<!--pages/profile/profile.wxml-->
<view class="profile-container">
  <!-- User Header -->
  <view class="profile-header">
    <image class="avatar" src="{{userInfo.avatar_url}}" mode="aspectFill"></image>
    <view class="user-info">
      <text class="nickname">{{userInfo.nickname || 'è‹±è¯­å­¦ä¹ è€…'}}</text>
      <text class="user-level">{{userInfo.grade || 'Primary School'}}</text>
      <view class="user-details">
        <text class="detail" wx:if="{{userInfo.age}}">å¹´é¾„: {{userInfo.age}}</text>
        <text class="detail" wx:if="{{userInfo.gender}}">æ€§åˆ«: {{userInfo.gender}}</text>
      </view>
    </view>
    <button class="edit-btn" bindtap="onEditProfile">
      <text class="edit-icon">âœï¸</text>
    </button>
  </view>

  <!-- Statistics -->
  <view class="stats-section">
    <text class="section-title">å­¦ä¹ ç»Ÿè®¡</text>
    <view class="stats-grid">
      <view class="stat-item">
        <text class="stat-number">{{stats.chat_history_count}}</text>
        <text class="stat-label">å¯¹è¯æ¬¡æ•°</text>
      </view>
      <!-- <view class="stat-item">
        <text class="stat-number">{{stats.vocab_count}}</text>
        <text class="stat-label">å­¦ä¹ è¯æ±‡</text>
      </view> -->
      <view class="stat-item">
        <text class="stat-number">{{Math.floor(stats.total_usage_time / 3600)}}</text>
        <text class="stat-label">å­¦ä¹ æ—¶é•¿(å°æ—¶)</text>
      </view>
      <view class="stat-item">
        <text class="stat-number">{{stats.days_since_registration}}</text>
        <text class="stat-label">åŠ å…¥å¤©æ•°</text>
      </view>
    </view>
  </view>

  <!-- Vocabulary Status -->
  <view class="vocab-section" wx:if="{{vocabStatus.total_vocab_count}}">
    <text class="section-title">è¯æ±‡çŠ¶æ€</text>
    <view class="vocab-stats">
      <view class="vocab-stat-item">
        <text class="vocab-stat-number">{{vocabStatus.total_vocab_count}}</text>
        <text class="vocab-stat-label">æ€»è¯æ±‡</text>
      </view>
      <view class="vocab-stat-item">
        <text class="vocab-stat-number">{{vocabStatus.mastered_vocab_count}}</text>
        <text class="vocab-stat-label">å·²æŒæ¡</text>
      </view>
      <view class="vocab-stat-item">
        <text class="vocab-stat-number">{{vocabStatus.unmastered_vocab_count}}</text>
        <text class="vocab-stat-label">å­¦ä¹ ä¸­</text>
      </view>
      <view class="vocab-stat-item">
        <text class="vocab-stat-number">{{Math.floor(vocabStatus.mastery_percentage)}}%</text>
        <text class="vocab-stat-label">æŒæ¡ç‡</text>
      </view>
    </view>
    
    <!-- Loaded Levels -->
    <view class="loaded-levels" wx:if="{{vocabStatus.added_vocab_levels && vocabStatus.added_vocab_levels.length > 0}}">
      <text class="levels-title">å·²åŠ è½½ç­‰çº§:</text>
      <view class="level-tags">
        <text class="level-tag" wx:for="{{vocabStatus.added_vocab_levels}}" wx:key="*this">
          {{item}} ({{vocabStatus.level_vocab_counts[item] || 0}})
        </text>
      </view>
    </view>
  </view>

  <!-- Actions -->
  <view class="actions-section">
    <button class="action-btn" bindtap="onLoadVocab">
      <text class="action-icon">ğŸ“š</text>
      <text class="action-text">åŠ è½½{{userInfo.grade || 'Primary School'}}è¯æ±‡</text>
    </button>
    
    <button class="action-btn" bindtap="onSync">
      <text class="action-icon">ğŸ”„</text>
      <text class="action-text">åŒæ­¥æ•°æ®</text>
    </button>
    
    <button class="action-btn debug" bindtap="onTestConnection">
      <text class="action-icon">ğŸ”§</text>
      <text class="action-text">è¿æ¥æµ‹è¯•</text>
    </button>
    
    <button class="action-btn danger" bindtap="onLogout">
      <text class="action-icon">ğŸšª</text>
      <text class="action-text">é€€å‡ºç™»å½•</text>
    </button>
  </view>
</view>

<!-- Edit Profile Modal -->
<view class="modal-overlay" wx:if="{{showEditModal}}" catchtap="onModalOverlayTap">
  <view class="modal-content" catchtap="stopPropagation">
    <view class="modal-header">
      <text class="modal-title">ç¼–è¾‘ä¸ªäººèµ„æ–™</text>
      <button class="modal-close" catchtap="onCloseEditModal">Ã—</button>
    </view>
    
    <view class="modal-body">
      <!-- Nickname -->
      <view class="form-field" catchtap="stopPropagation">
        <text class="form-label">æ˜µç§°:</text>
        <input class="form-input" 
               value="{{editProfile.nickname}}" 
               data-field="nickname" 
               bindinput="onEditInputChange"
               placeholder="è¯·è¾“å…¥æ˜µç§°"
               catchtap="stopPropagation"
               catchfocus="stopPropagation" />
      </view>
      
      <!-- Age -->
      <view class="form-field" catchtap="stopPropagation">
        <text class="form-label">å¹´é¾„:</text>
        <input class="form-input" 
               value="{{editProfile.age}}" 
               data-field="age" 
               bindinput="onEditInputChange"
               type="number"
               placeholder="è¯·è¾“å…¥å¹´é¾„"
               catchtap="stopPropagation"
               catchfocus="stopPropagation" />
      </view>
      
      <!-- Gender -->
      <view class="form-field" catchtap="stopPropagation">
        <text class="form-label">æ€§åˆ«:</text>
        <picker range="{{['Male', 'Female', 'Unspecified']}}" 
                value="{{currentGenderIndex}}"
                data-field="gender"
                bindchange="onPickerChange"
                catchtap="stopPropagation">
          <view class="form-picker">{{editProfile.gender || 'Unspecified'}}</view>
        </picker>
      </view>
      
      <!-- Grade -->
      <view class="form-field" catchtap="stopPropagation">
        <text class="form-label">å­¦ä¹ ç­‰çº§:</text>
        <picker range="{{availableGrades}}" 
                range-key="grade"
                value="{{currentGradeIndex}}"
                data-field="grade"
                bindchange="onPickerChange"
                catchtap="stopPropagation">
          <view class="form-picker">{{editProfile.grade || 'Primary School'}}</view>
        </picker>
      </view>
    </view>
    
    <view class="modal-footer">
      <button class="modal-btn cancel" bindtap="onCloseEditModal" catchtap="onCloseEditModal">å–æ¶ˆ</button>
      <button class="modal-btn save" bindtap="onSaveProfile" catchtap="onSaveProfile">ä¿å­˜</button>
    </view>
  </view>
</view>