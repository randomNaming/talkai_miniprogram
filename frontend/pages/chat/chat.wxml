<!--pages/chat/chat.wxml-->
<view class="chat-container">
  <!-- Header -->
  <view class="chat-header">
    <view class="header-content">
      <view class="chat-title">  Chat </view>
      <view class="chat-status">
        <text class="status-dot {{isOnline ? 'online' : 'offline'}}"></text>
        <text class="status-text">{{isOnline ? 'å°Yåœ¨çº¿' : 'è¿æ¥ä¸­...'}}</text>
      </view>
    </view>
    <view class="header-actions">
      <button class="action-btn" bindtap="onClearChat">
        <text class="action-icon">ğŸ—‘ï¸</text>
      </button>
      <button class="action-btn" bindtap="onShowSettings">
        <text class="action-icon">âš™ï¸</text>
      </button>
    </view>
  </view>

  <!-- Messages Area -->
  <scroll-view 
    class="messages-container" 
    scroll-y="true" 
    scroll-top="{{scrollTop}}"
    scroll-into-view="{{scrollToView}}"
    enhanced="true"
    show-scrollbar="false"
  >
    <view class="messages-list">
      <!-- Welcome Message -->
      <view class="message-item ai-message" wx:if="{{messages.length === 0}}">
        <view class="message-avatar">
          <text class="avatar-icon">ğŸ¤–</text>
        </view>
        <view class="message-content">
          <view class="message-bubble">
            <text class="message-text">{{welcomeMessage}}</text>
          </view>
          <view class="message-time">{{welcomeTime}}</view>
        </view>
      </view>

      <!-- Chat Messages -->
      <view 
        class="message-item {{item.type === 'user' ? 'user-message' : (item.type === 'system' ? 'system-message' : 'ai-message')}}"
        wx:for="{{messages}}" 
        wx:key="id"
        id="msg-{{item.id}}"
      >
        <!-- AIå’Œç³»ç»Ÿæ¶ˆæ¯ï¼šå¤´åƒåœ¨å·¦ä¾§ -->
        <view class="message-avatar" wx:if="{{item.type === 'ai' || item.type === 'system'}}">
          <text class="avatar-icon" wx:if="{{item.type === 'ai'}}">ğŸ¤–</text>
          <text class="avatar-icon" wx:if="{{item.type === 'system'}}">ğŸ“Š</text>
        </view>
        
        <view class="message-content">
          <view class="message-bubble">
            <text class="message-text" selectable="true">{{item.content}}</text>
            
            <!-- Grammar Correction -->
            <view class="grammar-correction" wx:if="{{item.grammar_check && item.grammar_check.has_error}}">
              <view class="correction-header">
                <text class="correction-icon">{{item.confidence_indicator || 'âœ“'}}</text>
                <text class="correction-title">è¯­æ³•çº æ­£</text>
                <text class="confidence-level" wx:if="{{item.confidence_level}}">({{item.confidence_level}})</text>
              </view>
              <view class="correction-content">
                <rich-text class="corrected-text-rich" nodes="{{item.highlighted_correction}}"></rich-text>
              </view>
              <!-- Explanation if available -->
              <view class="correction-explanation" wx:if="{{item.correction_explanation}}">
                <text class="explanation-icon">ğŸ’¡</text>
                <text class="explanation-text">{{item.correction_explanation}}</text>
              </view>
              <!-- Vocabulary to learn -->
              <view class="vocab-to-learn" wx:if="{{item.grammar_check.vocab_to_learn.length > 0}}">
                <text class="vocab-title">å·²è‡ªåŠ¨æ›´æ–°è¯æ±‡ï¼š</text>
                <view class="vocab-list">
                  <view 
                    class="vocab-item" 
                    wx:for="{{item.grammar_check.vocab_to_learn}}" 
                    wx:for-item="vocab"
                    wx:key="original"
                  >
                    <text class="vocab-original">{{vocab.original}}</text>
                    <text class="vocab-arrow">â†’</text>
                    <text class="vocab-corrected error-type-{{vocab.error_type || 'vocabulary'}}">{{vocab.corrected}}</text>
                  </view>
                </view>
              </view>
            </view>
          </view>
          
          <view class="message-time">{{item.time}}</view>
          
          <!-- Vocabulary Suggestions -->
          <view class="vocab-suggestions" wx:if="{{item.suggested_vocab && item.suggested_vocab.length > 0}}">
            <view class="suggestion-header">
              <text class="suggestion-icon">ğŸ“š</text>
              <text class="suggestion-title">æ¨èè¯æ±‡ç»ƒä¹ ï¼š</text>
            </view>
            <view class="suggestion-words">
              <text 
                class="suggested-word"
                wx:for="{{item.suggested_vocab}}"
                wx:key="*this"
                bindtap="onVocabSuggestionTap"
                data-word="{{item}}"
              >{{item}}</text>
            </view>
          </view>
          
          <!-- Message Actions -->
          <view class="message-actions" wx:if="{{item.type === 'ai'}}">
            <button class="action-btn-small" bindtap="onCopyMessage" data-content="{{item.content}}">
              <text class="action-icon-small">ğŸ“‹</text>
            </button>
            <button class="action-btn-small" bindtap="onTranslateMessage" data-content="{{item.content}}">
              <text class="action-icon-small">ğŸ”¤</text>
            </button>
          </view>
        </view>
        
        <view class="message-avatar" wx:if="{{item.type === 'user'}}">
          <text class="avatar-icon" wx:if="{{userAvatar === 'default_emoji' || !userAvatar}}">ğŸ‘¤</text>
          <image class="avatar-img" wx:else src="{{userAvatar}}" mode="aspectFill"></image>
        </view>
      </view>

      <!-- Loading Message -->
      <view class="message-item ai-message" wx:if="{{isLoading}}">
        <view class="message-avatar">
          <text class="avatar-icon">ğŸ¤–</text>
        </view>
        <view class="message-content">
          <view class="message-bubble loading-bubble">
            <view class="typing-indicator">
              <view class="typing-dot"></view>
              <view class="typing-dot"></view>
              <view class="typing-dot"></view>
            </view>
          </view>
        </view>
      </view>
    </view>
  </scroll-view>

  <!-- Input Area -->
  <view class="input-area">
    <view class="input-container">
      <textarea 
        class="message-input"
        placeholder="è¾“å…¥è‹±æ–‡æ¶ˆæ¯å¼€å§‹å¯¹è¯..."
        value="{{inputText}}"
        bindinput="onInputChange"
        bindconfirm="onSendMessage"
        confirm-type="send"
        maxlength="500"
        auto-height="true"
        disabled="{{isLoading}}"
      ></textarea>
      
      <view class="input-actions">
        <button 
          class="send-btn {{inputText.length > 0 ? 'active' : ''}}"
          bindtap="onSendMessage"
          disabled="{{isLoading || inputText.length === 0}}"
        >
          <text class="send-icon" wx:if="{{!isLoading}}">ğŸ“¤</text>
          <text class="send-icon" wx:else>â³</text>
        </button>
      </view>
    </view>
    
    <!-- Quick Actions -->
    <view class="quick-actions" wx:if="{{showQuickActions}}">
      <button class="quick-btn" bindtap="onQuickAction" data-action="greeting">
        <text class="quick-text">Hello!</text>
      </button>
      <button class="quick-btn" bindtap="onQuickAction" data-action="introduce">
        <text class="quick-text">è‡ªæˆ‘ä»‹ç»</text>
      </button>
      <button class="quick-btn" bindtap="onQuickAction" data-action="help">
        <text class="quick-text">éœ€è¦å¸®åŠ©</text>
      </button>
      <button class="quick-btn" bindtap="onQuickAction" data-action="topic">
        <text class="quick-text">æ¢ä¸ªè¯é¢˜</text>
      </button>
    </view>
  </view>

  <!-- Settings Modal -->
  <view class="settings-modal" wx:if="{{showSettings}}">
    <view class="modal-overlay" bindtap="onHideSettings"></view>
    <view class="modal-content">
      <view class="modal-header">
        <text class="modal-title">å¯¹è¯è®¾ç½®</text>
        <button class="modal-close" bindtap="onHideSettings">Ã—</button>
      </view>
      <view class="modal-body">
        <view class="setting-item">
          <text class="setting-label">æ˜¾ç¤ºè¯­æ³•çº æ­£</text>
          <switch 
            class="setting-switch" 
            checked="{{settings.showGrammarCorrection}}"
            bindchange="onSettingChange"
            data-key="showGrammarCorrection"
          ></switch>
        </view>
        <view class="setting-item">
          <text class="setting-label">åŒ…å«å¯¹è¯å†å²</text>
          <switch 
            class="setting-switch" 
            checked="{{settings.includeHistory}}"
            bindchange="onSettingChange"
            data-key="includeHistory"
          ></switch>
        </view>
        <view class="setting-item">
          <text class="setting-label">æ˜¾ç¤ºå¿«æ·æ“ä½œ</text>
          <switch 
            class="setting-switch" 
            checked="{{settings.showQuickActions}}"
            bindchange="onSettingChange"
            data-key="showQuickActions"
          ></switch>
        </view>
      </view>
    </view>
  </view>
</view>